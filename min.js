"use strict";navigator.serviceWorker&&navigator.serviceWorker.register("/tuner/sw.js",{scope:"/tuner/"});const fineTunePointer=document.getElementById("fineTunePointer"),fineTuneMarks=document.getElementById("fineTuneMarks"),justFrequency=document.getElementById("justFrequency"),noteDisplay=document.getElementById("noteDisplay"),noteLetter=document.getElementById("noteLetter"),accidental=document.getElementById("accidental"),octave=document.getElementById("octave"),settings=document.getElementById("settings"),openSettings=document.getElementById("openSettings"),darkModeCheck=document.getElementById("darkModeCheck"),freqCheck=document.getElementById("freqCheck"),adjustPrecision=document.getElementById("adjustPrecision"),showPrecision=document.getElementById("showPrecision"),adjustSensitivity=document.getElementById("adjustSensitivity"),showSensitivity=document.getElementById("showSensitivity"),adjustTuning=document.getElementById("adjustTuning"),showTuning=document.getElementById("showTuning"),adjustTicks=document.getElementById("adjustTicks"),showTicks=document.getElementById("showTicks"),moreSettingsCheck=document.getElementById("moreSettingsCheck"),notes=["A","B♭","B","C","C♯","D","E♭","E","F","F♯","G","A♭"],startOptions={darkMode:null,roundFreq:!0,fftSize:15,minDecibels:-70,tuning:2,tickNum:9,moreSettings:!1};let options=JSON.parse(localStorage.getItem("options"))||startOptions;const isInWebApp=!0===window.navigator.standalone||window.matchMedia("(display-mode: standalone)").matches;let audioCtxSampleRate,analyser,soundArray,settingsOpen=!1,initialPos={},touchMoved=!1,switchSettings=!1,framePending=!1;const moveSettingsAxis=()=>0===parseInt(getComputedStyle(document.documentElement).getPropertyValue("--settings-sideways"),10)?"Y":"X",darkMode=()=>window.matchMedia("(prefers-color-scheme: dark)"),closedVals={X:()=>-settings.offsetWidth+openSettings.offsetWidth-1,Y:()=>settings.offsetHeight-openSettings.offsetHeight+1},getAudio=async()=>makeAnalyser(await navigator.mediaDevices.getUserMedia({audio:!0}));function makeAnalyser(e){const t=new(window.AudioContext||window.webkitAudioContext);audioCtxSampleRate=t.sampleRate,analyser=t.createAnalyser(),updateAnalyser(),t.createMediaStreamSource(e).connect(analyser),soundArray=new Uint8Array(analyser.frequencyBinCount),showFrequency()}function updateAnalyser(){analyser.fftSize=Math.pow(2,options.fftSize),analyser.minDecibels=options.minDecibels}const interpolate=e=>e+(soundArray[e+1]-soundArray[e-1])/(soundArray[e]+soundArray[e-1]+soundArray[e+1]);function filterHarmonics(e){const t=Math.round(e/2);return soundArray[e]-soundArray[t]<Math.max(300-e+280-soundArray[e],60)?interpolate(t):interpolate(e)}function showFrequency(){requestAnimationFrame(showFrequency),analyser.getByteFrequencyData(soundArray);const e=filterHarmonics(soundArray.indexOf(Math.max(...soundArray)));if(isNaN(e))return;let t=e*audioCtxSampleRate/analyser.fftSize;freqCheck.checked&&(t=t.toFixed(1)),justFrequency.textContent=t;const n=Math.log(t/440)/.05776226504666215,s=Math.round(n);let i=s<0?notes.length+s%notes.length:s%notes.length;const o=notes[i=12===i?0:i];noteLetter.textContent=o.charAt(0),accidental.textContent=o.length>1?o.charAt(1):"",octave.textContent=Math.max(Math.floor((s+9)/notes.length)+4,0);const a=90*(n-s);Math.abs(a)<=options.tuning?noteDisplay.classList.replace("red","green"):noteDisplay.classList.replace("green","red"),fineTunePointer.style.transform=`rotate(${a}deg)`}function moveSettings(e){let t;t=!settingsOpen&&e||settingsOpen&&!e?closedVals[moveSettingsAxis()]():0,!e&&(settingsOpen=!settingsOpen),document.documentElement.style.setProperty("--settings"+moveSettingsAxis(),t+"px")}function sameKeys(...e){const t=e.reduce((e,t)=>e.concat(Object.keys(t)),[]),n=new Set(t);return e.every(e=>n.size===Object.keys(e).length)}function changeTicks(){fineTuneMarks.innerHTML="";for(let e=options.tickNum;e--;){const t=document.createElement("DIV");t.classList.add("tuningMark"),e%((options.tickNum-1)/2)==0&&t.classList.add("bigTick"),t.style.transform=`translateX(-50%) rotate(${90/(options.tickNum-1)*e-45}deg)`,fineTuneMarks.appendChild(t)}}function tuningOnOff(){-1===parseInt(adjustTuning.value,10)?(showTuning.value="",showTuning.placeholder="OFF"):showTuning.value=adjustTuning.value}function swipeSettings(e){if(framePending)return;const t={X:e.targetTouches[0].clientX,Y:e.targetTouches[0].clientY};touchMoved=!0,framePending=!0,requestAnimationFrame(()=>{framePending=!1;const e=closedVals[moveSettingsAxis()](),n=settingsOpen?0:e,s=initialPos[moveSettingsAxis()]-t[moveSettingsAxis()],i=Math.round(100*(n-s))/100;settings.style.transition="unset","Y"===moveSettingsAxis()?document.documentElement.style.setProperty("--settingsY",Math.max(Math.min(i,e),0)+"px"):document.documentElement.style.setProperty("--settingsX",Math.min(Math.max(i,e),0)+"px");const o="Y"===moveSettingsAxis()?settingsOpen:!settingsOpen;switchSettings=!o&&s>50||o&&s<-50})}window.matchMedia("(prefers-color-scheme: dark)").addListener(()=>{document.body.className="",darkModeCheck.checked=!darkModeCheck.checked,options.darkMode=null}),window.addEventListener("load",()=>{isInWebApp&&window.matchMedia("(orientation: landscape)")&&document.documentElement.style.setProperty("--hacky-hack-hack",settings.offsetWidth+"px"),window.setTimeout(()=>{document.documentElement.style.setProperty("--settings"+moveSettingsAxis(),closedVals[moveSettingsAxis()]()+"px")},10),getAudio(),changeTicks(),!sameKeys(startOptions,options)&&(options=startOptions),freqCheck.checked=options.roundFreq,adjustPrecision.value=options.fftSize,showPrecision.value=Math.pow(2,options.fftSize),adjustSensitivity.value=-1*options.minDecibels,showSensitivity.value=-1*options.minDecibels,adjustTicks.value=options.tickNum,showTicks.value=options.tickNum,adjustTuning.value=options.tuning,showTuning.value=-1===options.tuning?"":options.tuning,-1===options.tuning&&(showTuning.placeholder="OFF"),null!==options.darkMode?(document.body.classList.add(options.darkMode?"dark":"light"),darkModeCheck.checked=options.darkMode):darkModeCheck.checked=darkMode(),options.moreSettings&&(document.documentElement.style.setProperty("--more-settings-display","list-item"),showTuning.classList.remove("widestOption"),moreSettingsCheck.checked=options.moreSettings)},!1);const whichUnload=navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/iPhone/i)?"pagehide":"beforeunload";window.addEventListener(whichUnload,()=>{options.roundFreq=freqCheck.checked,localStorage.setItem("options",JSON.stringify(options))},!1),window.addEventListener("resize",()=>{const e="X"===moveSettingsAxis()?"Y":"X";document.documentElement.style.setProperty("--settings"+e,"-50%"),moveSettings(!0),isInWebApp&&(document.documentElement.style.setProperty("--hacky-hack-hack","0"),window.setTimeout(()=>{moveSettings(!0)},50))},!1),document.addEventListener("click",e=>{e.target.closest("#settings")?e.target.matches("#openSettings")&&!touchMoved?moveSettings(!1):e.target.matches("#reloader")&&(e.preventDefault(),window.location.reload()):(document.documentElement.style.setProperty("--settings"+moveSettingsAxis(),closedVals[moveSettingsAxis()]()+"px"),settingsOpen=!1)},!1),settings.addEventListener("touchstart",e=>{!e.target.matches("input")&&!e.target.matches(".checkmark")&&e.targetTouches[0].clientY<window.innerHeight&&(touchMoved=!1,switchSettings=!1,initialPos={X:e.targetTouches[0].clientX,Y:e.targetTouches[0].clientY},document.addEventListener("touchmove",swipeSettings,{passive:!0,useCapture:!0}),settings.addEventListener("touchend",()=>{settings.style.transition="transform 0.4s",touchMoved&&moveSettings(!switchSettings),document.removeEventListener("touchmove",swipeSettings,{passive:!0,useCapture:!0})},{useCapture:!0,once:!0}))},!0),settings.addEventListener("touchcancel",()=>{moveSettings(!0),window.setTimeout(()=>{moveSettings(!0)},100)},!1),darkModeCheck.addEventListener("input",()=>{options.darkMode=darkModeCheck.checked,document.body.className=options.darkMode?"dark":"light"},!1),adjustPrecision.addEventListener("input",()=>{showPrecision.value=Math.pow(2,adjustPrecision.value),options.fftSize=parseInt(adjustPrecision.value,10),updateAnalyser()},!1),adjustSensitivity.addEventListener("input",()=>{showSensitivity.value=adjustSensitivity.value,options.minDecibels=-1*adjustSensitivity.value,updateAnalyser()},!1),showSensitivity.addEventListener("input",()=>{2===showSensitivity.value.length?showSensitivity.value=Math.max(parseInt(showSensitivity.value,10),40):showSensitivity.value.length>2&&(showSensitivity.value=Math.min(parseInt(showSensitivity.value,10),100)),adjustSensitivity.value=showSensitivity.value,options.minDecibels=-1*parseInt(adjustSensitivity.value,10),updateAnalyser()},!1),showSensitivity.addEventListener("focusout",()=>{showSensitivity.value=adjustSensitivity.value},!1),adjustTuning.addEventListener("input",()=>{tuningOnOff(),options.tuning=parseInt(adjustTuning.value,10)},!1),showTuning.addEventListener("input",()=>{showTuning.value=Math.max(Math.min(parseInt(showTuning.value,10),10),-1),adjustTuning.value=showTuning.value,options.tuning=parseInt(adjustTuning.value,10),showTuning.placeholder=-1===parseInt(showTuning.value,10)?"OFF":"",-1===parseInt(showTuning.value,10)&&(showTuning.value="")},!1),showTuning.addEventListener("focusout",tuningOnOff,!1),adjustTicks.addEventListener("input",()=>{showTicks.value=adjustTicks.value,options.tickNum=parseInt(adjustTicks.value,10),changeTicks()},!1),moreSettingsCheck.addEventListener("input",()=>{document.documentElement.style.setProperty("--more-settings-display",moreSettingsCheck.checked?"list-item":"none"),moreSettingsCheck.checked?showTuning.classList.remove("widestOption"):showTuning.classList.add("widestOption"),options.moreSettings=moreSettingsCheck.checked},!1);